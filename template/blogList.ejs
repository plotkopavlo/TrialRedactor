<% layout('layout/page') -%>
<% block('title', "Документ") -%>

<script src="/socket.io/socket.io.js"></script>
<link rel="stylesheet" href="/css/blogList.css"/>

<div id="atricles">
    <h2>Atricles list</h2>
    <ul class="atricles-list" id="AtriclesList--list">

    </ul>

</div>

<template id="article">
	<li class="article">

			<a class="article--title" ></a>
			<div class="article--user-create" ></div>
      <div class="article--text" >
        <span class="article--text-aticle"></span>
        <a class="article--link" href="">... Дальше</a>
      </div>

      <div class="article--likes" ></div>
      <div class="article--reposts" ></div>

			<div class="article--data"></div>

	</li>
</template>

<script>
	var socket = io.connect('/bloglist', {
		reconnect: false
	});

	socket

		.on('newArticle', function (articles) {
			reWriteDocuments(articles);

		})
		.on('connect', function () {
			console.log("соединение установлено");
			socket.emit("sendData", function (articles) {
				console.log(articles);
				reWriteDocuments(articles);
			});

		})
		.on('disconnect', function () {
			//printStatus("соединение потеряно");
			setTimeout(reconnect, 500);
		});


	//return true;

	/**
	 * Перерисовка списка статей
	 * @param articles
	 */
	function reWriteDocuments(articles) {
		var listArticles = document.querySelector('.atricles-list');
		listArticles.innerHTML = "";
		var listElements = document.createDocumentFragment();
		articles.forEach(function (article) {
			var element = getElementFromTemplate(article);
			listElements.appendChild(element);
		});
		listArticles.appendChild(listElements);
	}

	function getElementFromTemplate (data) {
		var template = document.querySelector('#article')
		var element = template.content.children[0].cloneNode(true);
		element.querySelector('.article--title').textContent  = data.title;
		element.querySelector('.article--title').href  = 'blogArticle/?' + data.id;

		element.querySelector('.article--user-create').textContent  = data.userCreate;
		element.querySelector('.article--text-aticle').textContent  = data.text;
		element.querySelector('.article--link').href  = 'blogArticle/?' + data.id;
		element.querySelector('.article--likes').textContent  = data.likes;
		element.querySelector('.article--reposts').textContent  = data.reposts;
		element.querySelector('.article--data').textContent  = data.created;

		return element;
	}
	function reconnect() {
		socket.once('error', function () {
			setTimeout(reconnect, 500);
		});
		socket.socket.connect();
	}

	function printStatus(status) {
		console.log(status);
		var li = $('<li>');
		li.append($('<i>').text(status));
		li.appendTo(statusbar);
	}


</script>
